<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Super Dining ‚Ä¢ Clock-In Router</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; line-height:1.4; padding:24px; text-align:center; }
    .card { max-width:560px; margin:0 auto; border:1px solid #e5e7eb; border-radius:14px; padding:20px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2 { margin:0 0 8px; font-size:20px; }
    p { margin:8px 0; color:#374151; }
    .hint { color:#6b7280; font-size:14px; }
    .btn { display:inline-block; padding:10px 14px; border:0; border-radius:10px; cursor:pointer; font-size:15px; background:#111827; color:#fff; text-decoration:none; }
    .btn.alt { background:#4b5563; }
    .row { margin-top:14px; display:flex; justify-content:center; gap:8px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Loading‚Ä¶</h2>
    <p id="desc" class="hint"></p>
    <div class="row" id="actions" style="display:none;">
      <button class="btn alt" id="clear">Clear Saved Manager</button>
    </div>
  </div>

  <script>
    // ===== Config =====
    const JOTFORM_BASE = "https://form.jotform.com/251891698588077";
    const LS_MANAGER_KEY = "managerName";

    // ===== Helpers =====
    const $ = sel => document.querySelector(sel);
    const setTitle = t => $("#title").textContent = t;
    const setDesc  = d => $("#desc").innerHTML   = d;

    const qp = new URLSearchParams(location.search);
    const managerParam = qp.get("manager");
    const outletParam  = qp.get("outlet");

    const getManager = () => localStorage.getItem(LS_MANAGER_KEY);
    const setManager = v => localStorage.setItem(LS_MANAGER_KEY, v);
    const clearManager = () => localStorage.removeItem(LS_MANAGER_KEY);

    function cleanUrl() {
      try {
        const clean = location.origin + location.pathname;
        history.replaceState({}, document.title, clean);
      } catch(e) {}
    }

    function redirectToJotformGET(name, outlet) {
      // Jotform prefill works via GET only
      const params = new URLSearchParams({
        name: name || "",
        outlet: outlet || ""
      });
      // Use replace() so Back doesn‚Äôt return here
      location.replace(JOTFORM_BASE + "?" + params.toString());
    }

    // ===== Flow =====
    (function init(){
      // If manager link tapped: save and clean URL
      if (managerParam && managerParam.trim() !== "") {
        setManager(managerParam.trim());
        cleanUrl();
        setTitle("‚úÖ Manager Saved");
        setDesc(`Saved as <b>${managerParam.trim()}</b>. Now tap the outlet NFC tag to clock in.`);
        $("#actions").style.display = "flex";
        return;
      }

      // If outlet NFC tapped
      if (outletParam && outletParam.trim() !== "") {
        const saved = getManager();
        if (!saved) {
          cleanUrl();
          setTitle("üëã Manager Not Set");
          setDesc(`Please click your <b>Manager Link</b> first to save your name in this browser, then tap the outlet NFC tag again.`);
          $("#actions").style.display = "flex";
          return;
        }
        // We have both ‚Üí redirect with GET (reliable with Jotform)
        setTitle("‚è≥ Redirecting to Clock-In‚Ä¶");
        setDesc(`Manager: <b>${saved}</b> ‚Ä¢ Outlet: <b>${outletParam.trim()}</b>`);
        redirectToJotformGET(saved, outletParam.trim());
        return;
      }

      // No params
      cleanUrl();
      setTitle("‚ÑπÔ∏è How to Use");
      setDesc(`1) Tap your <b>Manager Link</b> (saves your name here).<br/>2) Then tap the <b>Outlet NFC tag</b> to clock in.`);
      $("#actions").style.display = "flex";
    })();

    // UI actions
    $("#clear").addEventListener("click", () => {
      clearManager();
      setTitle("üßπ Cleared");
      setDesc("Saved manager removed. Tap your Manager Link again to save it.");
    });
  </script>
</body>
</html>
