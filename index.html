<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Super Dining ‚Ä¢ Clock-In Router</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; line-height:1.4; padding:24px; }
    .card { max-width:560px; margin:0 auto; border:1px solid #e5e7eb; border-radius:14px; padding:20px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    h2 { margin:0 0 8px; font-size:20px; }
    p { margin:8px 0; color:#374151; }
    .hint { color:#6b7280; font-size:14px; }
    .row { margin-top:14px; display:flex; flex-wrap:wrap; gap:8px; }
    button, .btn {
      display:inline-block; padding:10px 14px; border:0; border-radius:10px; cursor:pointer; font-size:15px;
      background:#111827; color:#fff; text-decoration:none;
    }
    .btn.alt { background:#4b5563; }
    .btn.outline { background:#fff; color:#111827; border:1px solid #e5e7eb; }
    .pill { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f4f6; color:#111827; }
    .ok { color:#065f46; }
    .warn { color:#92400e; }
    .danger { color:#991b1b; }
    .small { font-size:13px; }
    .divider { height:1px; background:#f3f4f6; margin:14px 0; }
  </style>
</head>
<body>
  <div class="card" id="app">
    <h2 id="title">Loading‚Ä¶</h2>
    <p id="desc" class="hint"></p>

    <div id="manager-tools" style="display:none;">
      <div class="divider"></div>
      <p class="small"><span class="pill">Optional</span> Open this Manager Link in a different browser:</p>
      <div class="row" id="browser-buttons"></div>
      <p class="hint small" id="ios-tip" style="display:none;">On iPhone, if a button doesn‚Äôt open, use the Share menu ‚Üí ‚ÄúOpen in Safari/Chrome‚Äù.</p>
      <div class="divider"></div>
      <div class="row">
        <button class="btn outline" id="clear-cache">Clear Manager Cache</button>
        <a class="btn alt" id="retap-outlet" href="#" rel="nofollow">I‚Äôve set my browser ‚Üí Tap outlet NFC to clock-in</a>
      </div>
    </div>
  </div>

  <form id="hidden-post" method="POST" style="display:none;">
    <!-- action is set in JS -->
    <input type="hidden" name="name" />
    <input type="hidden" name="outlet" />
  </form>

<script>
  // ===== Config =====
  const JOTFORM_BASE = "https://form.jotform.com/251891698588077";
  const LS_MANAGER_KEY = "superdining_manager";

  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const query = new URLSearchParams(window.location.search);
  const managerParam = query.get("manager"); // from Manager Link
  const outletParam  = query.get("outlet");  // from Outlet NFC
  const ua = (navigator.userAgent || "").toLowerCase();

  function setTitle(t){ $("#title").textContent = t; }
  function setDesc(d){ $("#desc").textContent = d; }
  function getStoredManager(){ return localStorage.getItem(LS_MANAGER_KEY); }
  function storeManager(name){ localStorage.setItem(LS_MANAGER_KEY, name); }
  function clearManager(){ localStorage.removeItem(LS_MANAGER_KEY); }

  function cleanUrlBar() {
    try {
      const clean = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, clean);
    } catch (e) {}
  }

  function detectBrowserName() {
    // Order matters
    if (ua.includes("edg")) return "Edge";
    if (ua.includes("samsungbrowser")) return "Samsung Internet";
    if (ua.includes("crios")) return "Chrome (iOS)";
    if (ua.includes("fxios")) return "Firefox (iOS)";
    if (ua.includes("chrome") && !ua.includes("edg")) return "Chrome";
    if (ua.includes("firefox")) return "Firefox";
    if (ua.includes("safari") && !ua.includes("chrome")) return "Safari";
    return "your current browser";
  }

  // Deep-link helpers to reopen THIS SAME URL in another browser app.
  function deepLinkButtons() {
    const url = window.location.href; // includes ?manager=...
    const buttons = [];

    const isAndroid = /android/i.test(navigator.userAgent);
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

    if (isAndroid) {
      const u = new URL(url);
      const scheme = u.protocol.replace(":","");
      const pathAndQuery = u.pathname + u.search + u.hash;
      const base = `intent://${u.host}${pathAndQuery}#Intent;scheme=${scheme};package=`;

      const androidTargets = [
        { key:"chrome",  label:"Open in Chrome",  pkg:"com.android.chrome" },
        { key:"samsung", label:"Open in Samsung Internet", pkg:"com.sec.android.app.sbrowser" },
        { key:"edge",    label:"Open in Edge",    pkg:"com.microsoft.emmx" },
        { key:"firefox", label:"Open in Firefox", pkg:"org.mozilla.firefox" },
      ];

      androidTargets.forEach(t => {
        const a = document.createElement("a");
        a.className = "btn outline";
        a.textContent = t.label;
        a.href = `${base}${t.pkg};end`;
        a.rel = "nofollow";
        buttons.push(a);
      });
    } else if (isIOS) {
      // iOS custom schemes
      const chromeUrl  = url.replace(/^https:\/\//, "googlechromes://").replace(/^http:\/\//, "googlechrome://");
      const edgeUrl    = url.replace(/^https:\/\//, "microsoft-edge-https://").replace(/^http:\/\//, "microsoft-edge-http://");
      const firefoxUrl = "firefox://open-url?url=" + encodeURIComponent(url);
      // Safari: usually use Share ‚Üí Open in Safari; direct scheme not reliable cross-app

      const targets = [
        { label:"Open in Safari (use Share ‚Üí Open in Safari)", href:"#", note:"safari" },
        { label:"Open in Chrome",  href: chromeUrl },
        { label:"Open in Edge",    href: edgeUrl },
        { label:"Open in Firefox", href: firefoxUrl },
      ];

      targets.forEach(t => {
        const a = document.createElement("a");
        a.className = "btn outline";
        a.textContent = t.label;
        a.href = t.href;
        a.rel = "nofollow";
        buttons.push(a);
      });
      $("#ios-tip").style.display = "block";
    } else {
      // Desktop fallback ‚Äì just show same-window option
      const a = document.createElement("a");
      a.className = "btn outline";
      a.textContent = "Open Here";
      a.href = url;
      a.rel = "nofollow";
      buttons.push(a);
    }

    return buttons;
  }

  function redirectToJotFormPOST(name, outlet) {
    // Always clean the visible URL BEFORE redirect
    cleanUrlBar();
    const form = $("#hidden-post");
    form.action = JOTFORM_BASE;
    form.elements.name.value = name;
    form.elements.outlet.value = outlet;
    form.submit();
  }

  // ===== Core Flow =====
  (function init(){
    const currentBrowser = detectBrowserName();

    if (managerParam) {
      // MANAGER LINK FLOW
      storeManager(managerParam);
      cleanUrlBar();

      setTitle("‚úÖ Manager Saved");
      setDesc(`Hi ${managerParam}. From now on, please tap the outlet NFC tag in <b>${currentBrowser}</b> to clock in. If this isn‚Äôt the browser you want, you can open this Manager Link in another browser below.`);

      // Show manager tools: deep-link buttons + clear cache + retap hint
      const btnBox = $("#browser-buttons");
      deepLinkButtons().forEach(btn => btnBox.appendChild(btn));
      $("#manager-tools").style.display = "block";

      $("#clear-cache").onclick = () => {
        clearManager();
        setTitle("üîÅ Manager Cache Cleared");
        setDesc(`Cache removed. Open your Manager Link in your preferred browser to save it again. Then tap the outlet NFC tag in that same browser.`);
      };
      $("#retap-outlet").onclick = (e) => {
        e.preventDefault();
        setTitle("üìç Next Step");
        setDesc(`Now tap the outlet NFC tag in <b>${currentBrowser}</b> to proceed to clock in.`);
      };
      return;
    }

    if (outletParam) {
      // OUTLET NFC FLOW
      const storedManager = getStoredManager();
      if (storedManager) {
        setTitle("‚è≥ Redirecting to Clock-In‚Ä¶");
        setDesc(`Manager: <b>${storedManager}</b> ‚Ä¢ Outlet: <b>${outletParam}</b>`);
        // Hidden POST to JotForm (no URL params shown)
        redirectToJotFormPOST(storedManager, outletParam);
      } else {
        // No manager cache yet ‚Üí instruct to open Manager Link IN THIS BROWSER
        cleanUrlBar();
        setTitle("üëã One-time Setup Needed");
        setDesc(`You‚Äôre using <b>${currentBrowser}</b>. Please open your <b>Manager Link</b> in <b>${currentBrowser}</b> to save your manager name, then tap the outlet NFC tag again to clock in.`);
      }
      return;
    }

    // No recognizable params
    cleanUrlBar();
    setTitle("‚ÑπÔ∏è How to Use");
    setDesc(`1) Tap your <b>Manager Link</b> in your preferred browser (this saves your manager name in that browser).<br/>2) Then, at the outlet, tap the <b>Outlet NFC tag</b> in the <u>same browser</u> to clock in.`);
  })();
</script>
</body>
</html>
